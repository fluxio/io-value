<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="_io-base.html">
<link rel="import" href="_io-validator.html">

<dom-module id="io-number">
  <link rel="import" type="css" href="_io-base.css">
  <style>
    input {
      position: relative;
      font: inherit;
      padding: 0;
      margin: 0;
      border: none;
      background: transparent;
      color: inherit;
    }
    input:focus {
      outline: 0;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input {
        -moz-appearance:textfield;
    }
    /* TODO: IE */
    #invisibleValue {
      position: absolute;
      visibility: hidden;
      white-space: pre;
    }
  </style>
  <template>
    <input id="input"
        is="iron-input"
        allowed-pattern="[0-9.-]" prevent-invalid-input
        type="number"
        bind-value="{{immediatevalue}}"
        on-blur="_commitValue"
        placeholder="{{_placeholder}}"
        spellcheck="false">
      <!-- TODO: auto-sizing breaks when input is invalid -->
      <span id="invisibleValue">{{_placeholder}}</span>
    </input>
  </template>
</dom-module>
<script>
(function() {
  var rect;
  /*
  `<io-number>` is a custom HTML element that can be used as input/output for number variables.

  Example:

      <io-number
          value="{{numbervalue}}">
      </io-number>

  @demo demo.html
  */
  Polymer({
    is: 'io-number',
    properties: {
      _placeholder: {
        value: 'number',
        type: String,
        computed: '_computePlaceholder(immediatevalue)'
      }
    },
    behaviors: [
      Polymer.IoBase,
      Polymer.IoValidator
    ],
    _valueChanged: function() {
      if (this.value === 0) this.immediatevalue = String(this.value);
      else if (typeof this.value === 'boolean') this.immediatevalue = NaN;
      else this.immediatevalue = Number(this.value);
    },
    _immediatevalueChanged: function() {
      this.async(function() {
        rect = this.$.invisibleValue.getBoundingClientRect();
        this.$.input.style.width = rect.width + 1 + 'px';
      }.bind(this));
    },
    /**
     * Passes focus to internal input value editor
     */
    focus: function() {
      this.$.input.focus();
    },
    _commitValue: function() {
      if (this.isNumberString(this.$.input.value)) {
        this.setValue(Number(this.immediatevalue));
      } else if (this.immediatevalue === '') {
        this.setValue(null);
      }
    }
  });
}());
</script>
