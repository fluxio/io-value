<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="io-boolean.html">
<link rel="import" href="io-boolean-icon.html">
<link rel="import" href="io-number.html">
<link rel="import" href="io-string.html">
<link rel="import" href="io-object.html">
<link rel="import" href="io-function.html">

<dom-module id="io-value">
  <script>
    /*
    `<io-value>` is a custom HTML element that can be used as input/output for variables of various data types such as boolean, string, number or object. The element will instantiate a type-specific value editor when value type changes.

    Example:

        <io-value value="{{valueofanytype}}"></io-value>

    This element is reliant on a set of type-specific such as `<io-boolean>`, `<io-string>`, `<io-number>` and `<io-object>`. You can use these elements when you need an editor for a specific type.
        
    Example:

        <io-boolean value="{{booleanvalue}}"></io-boolean>
        <io-string value="{{stringvalue}}"></io-string>
        <io-number value="{{numbervalue}}"></io-number>
        <io-object value="{{objectvalue}}"></io-object>

    @demo demo.html
    */
    Polymer({
      is: 'io-value',
      properties: {
        /**
         * value
         */
        value: {
          value: null,
          notify: true,
          observer: '_valueChanged'
        },
        /**
         * immediate value (updated on each keystroke).
         */
        immediatevalue: {
          value: null,
          notify: true,
          observer: '_immediatevalueChanged'
        },
        /**
         * If disabled, value cannot be changed by user action.
         */
        disabled: {
          value: false,
          notify: true,
          type: Boolean,
          observer: '_disabledChanged'
        },
        /**
         * Type-specific editor instance.
         */
        _editor: {
          value: null,
          type: HTMLElement
        }
      },
      behaviors: [
        Polymer.IoValidator
      ],
      ready: function() {
        if (this.value === undefined) {
          this._valueChanged();
        }
      },
      _valueChanged: function() {
        this.immediatevalue = this.value;
        this._editor.value = this.value;
      },
      _immediatevalueChanged: function() {
        // Set empty string editor for undefined/null/NaN
        // with placeholder identifying the value type
        if (typeof this.immediatevalue === 'string') {
          this._setEditor('io-string');
        } else if (this.immediatevalue === undefined) {
          this._setEditor('io-string');
        } else if (this.immediatevalue === null) {
          this._setEditor('io-string');
        } else if (this.immediatevalue === NaN) {
          this._setEditor('io-string');
        } else if (typeof this.immediatevalue === 'object') {
          this._setEditor('io-object');
          this._editor.value = this.immediatevalue; // ?
        } else if (typeof this.immediatevalue === 'function') {
          this._setEditor('io-function');
        } else if (typeof this.immediatevalue === 'boolean') {
          this._setEditor('io-boolean');
        } else if (typeof this.immediatevalue === 'number') {
          this._setEditor('io-number');
        }
        this._editor.immediatevalue = this.immediatevalue;
      },
      _disabledChanged: function() {
        this._editor.disabled = this.disabled;
      },
      _valueSet: function(event) {
        // String type values have multiple special cases that convert to different types.
        if (event.path[0] !== this) {        
          var value = event.path[0].value;
          if (typeof value === 'string') {        
            if (value === 'true') {
              this.value = true;
            } else if (value === 'false') {
              this.value = false;
            } else if (value === 'null') {
              this.value = null;
            } else if (value === 'undefined') {
              this.value = undefined;
            } else if (value === 'NaN') {
              this.value = NaN;
            } else if (this.isNumberString(value)) {
              this.value = parseFloat(value);
            } else if (this.isJsonString(value)) {
              this.value = JSON.parse(value);
            }
          }
          this.fire('io-value-set');
        }
      },
      _contextmenuAction: function(event) {
        event.preventDefault();
        event.stopPropagation();
        if (typeof this.value === 'string') return;
        if (typeof this.value === 'boolean' || typeof this.value === 'number') {
          this._setEditor('io-string');
          // TODO: handle lid = false;
        }
      },
      _setEditor: function(editorName) {
        if (this._editor && this._editor.localName === editorName) return;
        this.textContent = '';
        this._editor = document.createElement(editorName);
        this.appendChild(this._editor);

        this._editor.value = this.value;
        this._editor.immediatevalue = this.immediatevalue;
        this._editor.disabled = this.disabled;

        this._editor.addEventListener('value-changed', function(event) {
          this.value = event.detail.value;
        }.bind(this));
        this._editor.addEventListener('immediatevalue-changed', function(event) {
          this.immediatevalue = event.detail.value;
        }.bind(this));

        this._editor.addEventListener('io-value-set', this._valueSet.bind(this));
        this._editor.addEventListener('contextmenu', this._contextmenuAction.bind(this));
      }
    });
  </script>
</polymer-element>
