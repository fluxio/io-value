<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="io-boolean.html">
<link rel="import" href="io-boolean-icon.html">
<link rel="import" href="io-number.html">
<link rel="import" href="io-string.html">
<link rel="import" href="io-object.html">
<link rel="import" href="io-function.html">

<dom-module id="io-value">
  <template></template>
  <script type="text/javascript">
  (function() {

    var range = document.createRange();
    var sel, value;

    Polymer({
      is: 'io-value',
      properties: {
        value: {
          value: null,
          notify: true,
          observer: '_valueChanged'
        },
        immediatevalue: {
          value: null,
          notify: true,
          observer: '_immediatevalueChanged'
        },
        disabled: {
          value: false,
          notify: true,
          type: Boolean,
          observer: '_disabledChanged'
        },
        expanded: {
          value: false,
          notify: true,
          type: Boolean,
          observer: '_expandedChanged'
        },
        corelist: {
          value: false,
          type: Boolean,
          observer: '_corelistChanged'
        },
        clickmasked: {
          value: false,
          type: Boolean,
          observer: '_clickmaskedChanged'
        },
        editor: {
          value: null,
          type: HTMLElement
        }
      },
      behaviors: [
        Polymer.IoValidator
      ],
      ready: function() {
        if (this.value === undefined) { // || this.value === null ?
          this._valueChanged();
        }
      },
      _valueChanged: function() {
        this.immediatevalue = this.value;
        this.editor.value = this.value;
      },
      _immediatevalueChanged: function() {
        // Set empty string editor for undefined/null/NaN
        // with placeholder identifying the value type
        if (typeof this.immediatevalue === 'string') {
          this._setEditor('io-string');
        } else if (this.immediatevalue === undefined) {
          this._setEditor('io-string');
        } else if (this.immediatevalue === null) {
          this._setEditor('io-string');
        } else if (this.immediatevalue === NaN) {
          this._setEditor('io-string');
        } else if (typeof this.immediatevalue === 'object') {
          this._setEditor('io-object');
          this.editor.value = this.immediatevalue; // ?
        } else if (typeof this.immediatevalue === 'function') {
          this._setEditor('io-function');
        } else if (typeof this.immediatevalue === 'boolean') {
          this._setEditor('io-boolean');
        } else if (typeof this.immediatevalue === 'number') {
          this._setEditor('io-number');
        }
        this.editor.immediatevalue = this.immediatevalue;
      },
      _disabledChanged: function() {
        this.editor.disabled = this.disabled;
      },
      _expandedChanged: function() {
        this.editor.expanded = this.expanded;
      },
      _corelistChanged: function() {
        this.editor.corelist = this.corelist;
        if (this.corelist) {
          this.editor.setAttribute('fit', '');
        } else {
          this.editor.removeAttribute('fit');
        }
      },
      _clickmaskedChanged: function() {
        this.editor.clickmasked = this.clickmasked;
      },
      _valueSet: function(event) {
        // String type values have multiple special cases that convert to different types.
        if (event.path[0] !== this) {        
          value = event.path[0].value;
          if (typeof value === 'string') {        
            if (value === 'true') {
              this.value = true;
            } else if (value === 'false') {
              this.value = false;
            } else if (value === 'null') {
              this.value = null;
            } else if (value === 'undefined') {
              this.value = undefined;
            } else if (value === 'NaN') {
              this.value = NaN;
            } else if (this.isNumberString(value)) {
              this.value = parseFloat(value);
            } else if (this.isJsonString(value)) {
              this.value = JSON.parse(value);
            }
          }
          this.fire('io-value-set');
        }
      },
      _contextmenuAction: function(event) {
        event.preventDefault();
        event.stopPropagation();
        if (typeof this.value === 'string') return;
        if (typeof this.value === 'boolean' || typeof this.value === 'number') {
          this._setEditor('io-string');
          // TODO: handle object and function
          this.editor.textContent = String(this.value);
          this.editor._selectContent(true);
          this.editor.invalid = false;
        }
      },
      _setEditor: function(editorName) {
        if (this.editor && this.editor.localName === editorName) return;
        this.textContent = '';
        this.editor = document.createElement(editorName);
        this.appendChild(this.editor);

        this.editor.value = this.value;
        this.editor.immediatevalue = this.immediatevalue;
        this.editor.disabled = this.disabled;
        this.editor.expanded = this.expanded;
        this.editor.corelist = this.corelist;
        this.editor.clickmasked = this.clickmasked;

        this.editor.addEventListener('value-changed', function(event) {
          this.value = event.detail.value;
        }.bind(this));
        this.editor.addEventListener('immediatevalue-changed', function(event) {
          this.immediatevalue = event.detail.value;
        }.bind(this));
        this.editor.addEventListener('expanded-changed', function(event) {
          this.expanded = event.detail.value;
        }.bind(this));

        this.editor.addEventListener('io-value-set', this._valueSet.bind(this));
        this.editor.addEventListener('contextmenu', this._contextmenuAction.bind(this));
        // TODO: profile memory
        this._corelistChanged();
      }
    });
  }());
  </script>
</dom-module>
